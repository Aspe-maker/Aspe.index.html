<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>مذكرة الأهداف - تصميم زجاجي</title>
<style>
  :root{
    --bg:#0f1724;
    --glass-bg: rgba(255,255,255,0.06);
    --accent: #7c5cff;
    --success: #48c774;
    --danger: #ff6b6b;
    --glass-border: rgba(255,255,255,0.12);
    --card-radius: 14px;
  }
  *{box-sizing:border-box;font-family: "Segoe UI", Tahoma, Arial, sans-serif}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071022 0%, #0f1724 100%);color:#e6eef8;direction:rtl}
  .app{
    min-height:100vh;
    display:flex;
    gap:20px;
    align-items:flex-start;
    justify-content:center;
    padding:48px 20px;
  }

  .panel{
    backdrop-filter: blur(8px) saturate(120%);
    -webkit-backdrop-filter: blur(8px) saturate(120%);
    background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    border: 1px solid var(--glass-border);
    border-radius: var(--card-radius);
    padding:18px;
    box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    transition: transform .28s cubic-bezier(.2,.9,.3,1), box-shadow .28s;
  }
  .panel:hover{transform: translateY(-6px); box-shadow: 0 18px 50px rgba(2,6,23,0.7)}

  .calendar{width:420px;max-width:92vw;}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;}

  .date-glass{
    padding:12px 16px;border-radius:12px;display:flex;gap:12px;align-items:center;
    background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06);
  }

  .date-big{font-size:20px;font-weight:700}
  .date-small{font-size:12px;color:#bcd1ff90}

  .calendar-grid{
    display:grid;
    grid-template-columns: repeat(7,1fr);
    gap:10px;
  }

  .day{
    padding:12px;border-radius:10px;min-height:78px;
    display:flex;flex-direction:column;justify-content:space-between;
    transition: transform .28s, background .28s;
    cursor:pointer;border:1px solid transparent;
    background: rgba(255,255,255,0.02);
  }
  .day:hover{transform:translateY(-6px)}
  .day.locked{opacity:0.66;pointer-events:none;filter:grayscale(.05)}

  .day .day-num{font-weight:700}
  .status{
    display:inline-flex;align-items:center;gap:6px;font-size:13px;padding:6px 8px;border-radius:8px;
  }
  .ok{background: rgba(72,199,116,0.14); color:var(--success);}
  .fail{background: rgba(255,107,107,0.12); color:var(--danger);}
  .pending{background: rgba(124,92,255,0.10); color:var(--accent);}

  /* Editor */
  .editor{width:440px;max-width:92vw;display:flex;flex-direction:column;gap:12px}
  .h{font-weight:800;font-size:16px}
  .card{padding:12px;border-radius:12px;background:var(--glass-bg);border:1px solid var(--glass-border)}
  label{font-size:13px;color:#c9dbffb3}
  input[type="number"],input[type="text"]{
    width:100%;padding:8px;margin-top:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;
  }
  .tasks{display:flex;flex-direction:column;gap:8px;max-height:320px;overflow:auto;padding-right:6px}
  .task{display:flex;gap:8px;align-items:center;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .task.done{opacity:0.7;text-decoration:line-through}
  .pts{padding:6px 8px;background:rgba(255,255,255,0.03);border-radius:8px;font-weight:700}

  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{
    background:linear-gradient(90deg,var(--accent), #5e9bff);color:white;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;
    box-shadow:0 6px 20px rgba(124,92,255,0.14);transition:transform .15s;
  }
  button:active{transform:translateY(2px)}

  .progress{height:12px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent), #5e9bff);width:0%;transition:width .6s}

  .stats{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .stat{padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
  .small{font-size:12px;color:#bcd1ff90}

  @media(max-width:980px){
    .app{flex-direction:column;align-items:center}
    .calendar,.editor{width:96%}
  }
</style>
</head>
<body>
<div class="app">

  <!-- CALENDAR -->
  <div class="panel calendar">
    <div class="topbar">
      <div class="date-glass">
        <div>
          <div class="date-big" id="todayStr">—</div>
          <div class="date-small" id="todayTime">—</div>
        </div>
      </div>
      <div style="text-align:left">
        <div class="small">بداية التقويم: <b>26</b></div>
        <div class="small">التاريخ: ميلادي</div>
      </div>
    </div>

    <div class="calendar-grid" id="calendarGrid"></div>
  </div>

  <!-- EDITOR -->
  <div class="panel editor">
    <div class="h">محرر اليوم</div>

    <div class="card">
      <label>اليوم المحدد: <span id="selectedDayLabel" style="font-weight:800"></span></label>

      <div class="small">هدف النقاط</div>
      <input type="number" id="dayTarget" min="1" value="20" />

      <div style="height:8px"></div>
      <div class="small">المهام</div>
      <div class="tasks" id="tasksList"></div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <input type="text" id="newTaskText" placeholder="وصف المهمة" />
        <input type="number" id="newTaskPts" value="5" style="width:90px" />
        <button id="addTaskBtn">أضف</button>
      </div>

      <div style="height:12px"></div>
      <div class="small">التقدم</div>
      <div class="progress"><i id="progressFill"></i></div>
      <div style="display:flex;justify-content:space-between;margin-top:8px">
        <div class="small">المجموع: <b id="sumPts">0</b></div>
        <div class="small">الهدف: <b id="showTarget">0</b></div>
      </div>

      <div class="controls" style="margin-top:10px">
        <button id="saveDayBtn">حفظ</button>
        <button id="lockDayBtn">قفل اليوم</button>
        <button id="resetDayBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.06)">إعادة</button>
      </div>
    </div>

    <div class="card stats">
      <div class="stat"><div class="small">أيام مكتملة</div><div id="doneCount">0</div></div>
      <div class="stat"><div class="small">أيام فائتة</div><div id="missedCount">0</div></div>
      <div style="flex:1;text-align:left">
        <div class="small">إجمالي المتابعة</div>
        <div id="totalDays">0</div>
      </div>
    </div>
  </div>

</div>

<script>
// ===================================================================
// CONFIG
// ===================================================================
const STORAGE_KEY = "glassPlanner_v1";
const TIMEZONE = "Asia/Riyadh";
const START_DAY_OF_MONTH = 26;
const END_DATE = new Date("2026-01-03T00:00:00");

// ===================================================================
// HELPERS
// ===================================================================
function nowRiyadh(){
  return new Date(new Date().toLocaleString("en-US",{timeZone:TIMEZONE}));
}

function formatKey(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

function fmt(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

function startDay(d){
  const x = new Date(d);
  x.setHours(0,0,0,0);
  return x;
}

// ===================================================================
let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{"days":{}}');
let selectedKey = null;

// ===================================================================
// BUILD CALENDAR
// ===================================================================
function buildCalendar(){
  const grid = document.getElementById("calendarGrid");
  grid.innerHTML = "";

  const now = nowRiyadh();
  document.getElementById("todayStr").textContent = fmt(now);
  document.getElementById("todayTime").textContent =
    now.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:TIMEZONE});

  // determine starting point
  let base = new Date(now.getFullYear(), now.getMonth(), START_DAY_OF_MONTH);
  if(now.getDate() < START_DAY_OF_MONTH){
    base.setMonth(base.getMonth() - 1);
  }

  for(let i=0;i<60;i++){
    let d = new Date(base);
    d.setDate(base.getDate() + i);

    if(d > END_DATE) break;

    let key = formatKey(d);
    let div = document.createElement("div");
    div.className = "day";
    div.dataset.key = key;

    div.innerHTML = `
      <div>
        <div class="day-num">${d.getDate()}</div>
        <div class="small">${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}</div>
      </div>
      <div class="status pending">مفتوح</div>
    `;

    div.onclick = ()=> openDay(key,d);

    applyStatusToCell(div,key);
    grid.appendChild(div);
  }

  autoLock();
  refreshStats();
}

// ===================================================================
// APPLY STATUS TO CELL
// ===================================================================
function applyStatusToCell(cell,key){
  let ds = state.days[key];
  let st = cell.querySelector(".status");

  if(!ds){
    st.className="status pending";
    st.textContent="مفتوح";
    return;
  }

  if(ds.locked){
    cell.classList.add("locked");
    if(ds.success){
      st.className="status ok"; st.textContent="صح";
    } else {
      st.className="status fail"; st.textContent="خطأ";
    }
  } else {
    cell.classList.remove("locked");
    st.className="status pending";
    st.textContent=`${ds.sum||0}/${ds.target||0}`;
  }
}

// ===================================================================
// OPEN DAY
// ===================================================================
function openDay(key,d){
  selectedKey = key;

  document.getElementById("selectedDayLabel").textContent = fmt(d);

  if(!state.days[key]){
    state.days[key] = {target:20,tasks:[],sum:0,locked:false,success:false};
  }

  document.getElementById("dayTarget").value = state.days[key].target;

  renderTasks();
  updateProgress();
}

// ===================================================================
function renderTasks(){
  let box = document.getElementById("tasksList");
  box.innerHTML="";

  let ds = state.days[selectedKey];

  ds.tasks.forEach((t,i)=>{
    let div = document.createElement("div");
    div.className="task"+(t.done?" done":"");

    div.innerHTML = `
      <input type="checkbox" ${t.done?"checked":""} data-i="${i}" />
      <div style="flex:1;font-weight:700">${t.title}</div>
      <div class="pts">${t.pts}</div>
      <button data-del="${i}" style="background:transparent;border:1px solid rgba(255,255,255,0.1);padding:4px 8px;border-radius:8px">حذف</button>
    `;

    div.querySelector("input").onchange = (e)=>{
      ds.tasks[i].done = e.target.checked;
      recalc(selectedKey);
      save();
      renderTasks();
      updateCell(selectedKey);
    };

    div.querySelector("button").onclick = ()=>{
      ds.tasks.splice(i,1);
      recalc(selectedKey);
      save();
      renderTasks();
      updateCell(selectedKey);
    };

    box.appendChild(div);
  });

  if(ds.tasks.length===0){
    box.innerHTML='<div class="small">ما فيه مهام</div>';
  }
}

function recalc(key){
  let ds = state.days[key];
  ds.sum = ds.tasks.filter(t=>t.done).reduce((a,b)=>a+b.pts,0);
  ds.success = ds.sum >= ds.target;
}

function updateProgress(){
  let ds = state.days[selectedKey];
  document.getElementById("sumPts").textContent = ds.sum;
  document.getElementById("showTarget").textContent = ds.target;
  document.getElementById("progressFill").style.width =
    (ds.target? ds.sum/ds.target*100 : 0) + "%";
}

function updateCell(key){
  let cell = document.querySelector(`.day[data-key="${key}"]`);
  if(cell) applyStatusToCell(cell,key);
  refreshStats();
}

document.getElementById("addTaskBtn").onclick = ()=>{
  let txt = document.getElementById("newTaskText").value.trim();
  let pts = parseInt(document.getElementById("newTaskPts").value)||1;
  if(!txt) return;

  state.days[selectedKey].tasks.push({title:txt,pts:pts,done:false});
  recalc(selectedKey);
  save();
  renderTasks();
  updateProgress();
  updateCell(selectedKey);

  document.getElementById("newTaskText").value="";
};

document.getElementById("dayTarget").oninput = (e)=>{
  let ds = state.days[selectedKey];
  ds.target = parseInt(e.target.value)||1;
  recalc(selectedKey);
  save();
  updateProgress();
  updateCell(selectedKey);
};

document.getElementById("saveDayBtn").onclick = ()=>{
  recalc(selectedKey);
  save();
  updateCell(selectedKey);
  alert("تم حفظ اليوم.");
};

document.getElementById("lockDayBtn").onclick = ()=>{
  let ds = state.days[selectedKey];
  recalc(selectedKey);
  ds.locked=true;
  ds.success = ds.sum >= ds.target;
  save();
  updateCell(selectedKey);
};

document.getElementById("resetDayBtn").onclick = ()=>{
  if(!confirm("متأكد؟")) return;
  state.days[selectedKey] = {target:20,tasks:[],sum:0,locked:false,success:false};
  save();
  renderTasks();
  updateProgress();
  updateCell(selectedKey);
};

// ===================================================================
// AUTO LOCK
// ===================================================================
function autoLock(){
  const now = startDay(nowRiyadh());
  const todayKey = formatKey(now);

  for(const k in state.days){
    if(k < todayKey){
      if(!state.days[k].locked){
        recalc(k);
        state.days[k].locked=true;
      }
    }
  }
  save();
  document.querySelectorAll(".day").forEach(el=>applyStatusToCell(el,el.dataset.key));
}

// ===================================================================
function refreshStats(){
  let done=0,miss=0,total=0;

  Object.values(state.days).forEach(d=>{
    total++;
    if(d.locked){
      if(d.success) done++; else miss++;
    }
  });

  document.getElementById("doneCount").textContent = done;
  document.getElementById("missedCount").textContent = miss;
  document.getElementById("totalDays").textContent = total;
}

function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

// ===================================================================
buildCalendar();

// افتح يوم اليوم تلقائيًا
openDay( formatKey(startDay(nowRiyadh())), new Date(nowRiyadh()) );

setInterval(()=>{
  let now = nowRiyadh();
  document.getElementById("todayStr").textContent = fmt(now);
  document.getElementById("todayTime").textContent =
    now.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",second:"2-digit",timeZone:TIMEZONE});

  autoLock();
},60000);
</script>
</body>
</html>
