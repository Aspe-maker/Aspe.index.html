// بداية اللعبة وتحديد محرك العرض Three.js أو Babylon.js
let engine = new BABYLON.Engine(canvas, true);
let scene = new BABYLON.Scene(engine);

// إعداد الكاميرا، والتحكم في الحركة
let camera = new BABYLON.ArcRotateCamera("Camera", Math.PI / 2, Math.PI / 4, 10, BABYLON.Vector3.Zero(), scene);
camera.attachControl(canvas, true);

// إنشاء العالم المفتوح باستخدام "البحث التوليدي" - على سبيل المثال، التضاريس المتنوعة
function createTerrain() {
    let ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 100, height: 100, subdivisions: 4}, scene);
    ground.material = new BABYLON.StandardMaterial("groundMat", scene);
    ground.material.diffuseColor = new BABYLON.Color3(0.2, 0.7, 0.2); // العشب
    // إضافة التضاريس المتنوعة
    for (let i = 0; i < 50; i++) {
        let x = Math.random() * 100 - 50;
        let z = Math.random() * 100 - 50;
        let tree = BABYLON.MeshBuilder.CreateCylinder("tree", {height: 10, diameter: 2}, scene);
        tree.position = new BABYLON.Vector3(x, 5, z);
        tree.material = new BABYLON.StandardMaterial("treeMat", scene);
        tree.material.diffuseColor = new BABYLON.Color3(0.5, 0.3, 0.1); // جذع الشجرة
    }
}

// نظام التخزين (Inventory System)
let inventory = [];
function createInventory() {
    // إضافة 20 مكان في المخزون
    for (let i = 0; i < 20; i++) {
        inventory.push(null); // يمكن تخزين العناصر في هذه الأماكن
    }
    // زر لفتح المخزون
    let inventoryButton = document.createElement('button');
    inventoryButton.innerText = "فتح المخزون";
    inventoryButton.onclick = function() {
        showInventory();
    };
    document.body.appendChild(inventoryButton);
}

// عرض المخزون عند الضغط على الزر
function showInventory() {
    let inventoryWindow = document.createElement('div');
    inventoryWindow.style.position = 'absolute';
    inventoryWindow.style.top = '50px';
    inventoryWindow.style.left = '50px';
    inventoryWindow.style.backgroundColor = '#fff';
    inventoryWindow.style.padding = '10px';
    inventoryWindow.style.border = '1px solid black';
    
    for (let i = 0; i < 20; i++) {
        let itemSlot = document.createElement('div');
        itemSlot.innerText = inventory[i] ? inventory[i].name : 'مربع فارغ';
        inventoryWindow.appendChild(itemSlot);
    }
    
    document.body.appendChild(inventoryWindow);
}

// إضافة الكتل القابلة للبناء والتكسير (Building and Mining System)
function createBlock(x, y, z, material) {
    let block = BABYLON.MeshBuilder.CreateBox("block", {size: 1}, scene);
    block.position = new BABYLON.Vector3(x, y, z);
    block.material = new BABYLON.StandardMaterial("blockMat", scene);
    block.material.diffuseColor = material;
    return block;
}

// نظام الكاميرا (Camera System)
function createCamera() {
    let camera = new BABYLON.FreeCamera("Camera", new BABYLON.Vector3(0, 5, -10), scene);
    camera.setTarget(BABYLON.Vector3.Zero());
    camera.attachControl(canvas, true);
    return camera;
}

// إعداد حركة الشخصية (Movement System)
function createMovement() {
    let player = BABYLON.MeshBuilder.CreateSphere("player", {diameter: 1}, scene);
    player.position = new BABYLON.Vector3(0, 1, 0);

    // الحركة السلسة
    scene.registerBeforeRender(function () {
        if (camera.position.z < -10) camera.position.z = -10;
        if (camera.position.x > 50) camera.position.x = 50;
        // تحريك الكاميرا وفقاً لمفاتيح WASD
        if (inputMap["w"]) camera.position.z -= 0.1;
        if (inputMap["s"]) camera.position.z += 0.1;
        if (inputMap["a"]) camera.position.x -= 0.1;
        if (inputMap["d"]) camera.position.x += 0.1;
    });
}

// إضافة حركة سلسة للكاميرا (سحب الكاميرا إلى الأمام والخلف، مع القفز)
function enableSmoothControls() {
    let speed = 0.2;
    let jumpSpeed = 1;
    let gravity = 0.05;

    let jumpButton = document.createElement('button');
    jumpButton.innerText = "القفز";
    jumpButton.onclick = function() {
        camera.position.y += jumpSpeed;
    };
    document.body.appendChild(jumpButton);
}

// نظام التكسير والبناء (Building and Mining)
function mineBlock(x, y, z) {
    let block = BABYLON.MeshBuilder.CreateBox("block", {size: 1}, scene);
    block.position = new BABYLON.Vector3(x, y, z);
    block.material = new BABYLON.StandardMaterial("blockMat", scene);
    block.material.diffuseColor = new BABYLON.Color3(0.2, 0.2, 0.2); // حجر

    // كود لتكسير الكتل
    block.actionManager = new BABYLON.ActionManager(scene);
    block.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger, function(evt) {
        block.dispose(); // تدمير الكتلة عند النقر عليها
    }));
}

// إنشاء ديناميكية تغيير الوقت (Day-Night Cycle)
function dayNightCycle() {
    let sun = new BABYLON.DirectionalLight("sun", new BABYLON.Vector3(0, -1, 0), scene);
    sun.position = new BABYLON.Vector3(0, 100, 0);
    
    scene.registerBeforeRender(function () {
        let time = Date.now() * 0.0001;
        sun.setDirection(new BABYLON.Vector3(Math.cos(time), -1, Math.sin(time)));
    });
}

// تفعيل الطقس الديناميكي (Weather)
function dynamicWeather() {
    let rain = new BABYLON.WeatherSystem(scene);
    rain.rainIntensity = 0.7; // تعيين شدة المطر
}

// تحميل البيئة بالتقنيات المتقدمة
function loadEnvironment() {
    createTerrain();
    createInventory();
    createCamera();
    createMovement();
    dayNightCycle();
    dynamicWeather();
}

// بداية اللعبة
loadEnvironment();
engine.runRenderLoop(function () {
    scene.render();
});

// التعامل مع حجم الشاشة
window.addEventListener("resize", function () {
    engine.resize();
});
